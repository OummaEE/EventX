<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventX - Advanced PWA</title>
    <meta name="description" content="EventX Advanced PWA - Book escape rooms with push notifications, Apple Pay, and offline support">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="EventX">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
    <link rel="apple-touch-icon" href="/icons/icon-180x180.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3b82f6">

    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="/css/styles.css">

    <!-- Apple Pay Domain Validation -->
    <meta name="apple-pay-domain-validation" content="merchant.com.eventx.booking">
</head>
<body>
    <!-- PWA Header -->
    <header class="pwa-header">
        <div class="header-content">
            <div class="logo">EventX</div>
            <div class="header-actions">
                <button class="install-button" id="installButton">
                    <span class="material-icons">get_app</span>
                    Install App
                </button>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userEmail"></span>
                    <button class="btn-outline" onclick="logout()" style="padding: 8px 16px; font-size: 0.75rem;">
                        <span class="material-icons" style="font-size: 16px;">logout</span>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <span class="material-icons" style="font-size: 16px;">cloud_off</span>
        You're offline
    </div>

    <!-- Main Content -->
    <main>
        <!-- Home Tab -->
        <div id="homeTab" class="tab-content active">
            <div class="hero-section">
                <h1 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; text-align: center;">
                    Welcome to EventX
                </h1>
                <p style="font-size: 1.125rem; color: var(--text-secondary); text-align: center; margin-bottom: 2rem;">
                    Advanced PWA with push notifications, Apple Pay, and offline support
                </p>
            </div>

            <!-- Login/Register Forms -->
            <div id="authSection">
                <div class="card" style="max-width: 400px; margin: 0 auto;">
                    <div class="card-header">
                        <div class="auth-tabs" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <button class="btn btn-outline auth-tab active" onclick="showAuthTab('login')" id="loginTabBtn">
                                Login
                            </button>
                            <button class="btn btn-outline auth-tab" onclick="showAuthTab('register')" id="registerTabBtn">
                                Register
                            </button>
                        </div>
                    </div>

                    <div class="card-content">
                        <!-- Login Form -->
                        <form id="loginForm" style="display: block;">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="loginEmail" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="loginPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <span class="material-icons">login</span>
                                Login
                            </button>
                        </form>

                        <!-- Register Form -->
                        <form id="registerForm" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-input" id="registerName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="registerEmail" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-input" id="registerPhone" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="registerPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <span class="material-icons">person_add</span>
                                Register
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Services Section (shown after login) -->
            <div id="servicesSection" style="display: none;">
                <h2 style="font-size: 1.75rem; font-weight: 600; margin-bottom: 1.5rem; text-align: center;">
                    Our Services
                </h2>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <!-- QuestBox -->
                    <div class="card">
                        <div class="card-content">
                            <h3 class="card-title">QuestBox</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Escape room experience in a box. Perfect for team building and parties.
                            </p>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <span class="material-icons" style="color: var(--text-light);">schedule</span>
                                <span>60 minutes</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                                <span class="material-icons" style="color: var(--text-light);">group</span>
                                <span>2-6 players</span>
                            </div>
                            <button class="btn btn-primary" onclick="showBookingForm('QuestBox')" style="width: 100%;">
                                Book Now - 500 SEK
                            </button>
                        </div>
                    </div>

                    <!-- QuestGames -->
                    <div class="card">
                        <div class="card-content">
                            <h3 class="card-title">QuestGames</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Digital escape room games with immersive storylines and puzzles.
                            </p>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <span class="material-icons" style="color: var(--text-light);">schedule</span>
                                <span>45 minutes</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                                <span class="material-icons" style="color: var(--text-light);">group</span>
                                <span>1-4 players</span>
                            </div>
                            <button class="btn btn-primary" onclick="showBookingForm('QuestGames')" style="width: 100%;">
                                Book Now - 300 SEK
                            </button>
                        </div>
                    </div>

                    <!-- QuestHouse -->
                    <div class="card">
                        <div class="card-content">
                            <h3 class="card-title">QuestHouse</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Full-scale escape room facility with multiple themed rooms.
                            </p>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <span class="material-icons" style="color: var(--text-light);">schedule</span>
                                <span>90 minutes</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                                <span class="material-icons" style="color: var(--text-light);">group</span>
                                <span>4-10 players</span>
                            </div>
                            <button class="btn btn-primary" onclick="showBookingForm('QuestHouse')" style="width: 100%;">
                                Book Now - 800 SEK
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookings Tab -->
        <div id="bookingsTab" class="tab-content">
            <!-- Online Content -->
            <div class="online-content">
                <h2 style="font-size: 1.75rem; font-weight: 600; margin-bottom: 1.5rem;">My Bookings</h2>

                <!-- Push Notification Settings -->
                <div class="notification-settings">
                    <div class="notification-toggle">
                        <div>
                            <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.25rem;">
                                Push Notifications
                            </h3>
                            <p style="color: var(--text-secondary); font-size: 0.875rem;">
                                Get reminders about your upcoming bookings
                            </p>
                        </div>
                        <div class="toggle-switch" id="notificationToggle" onclick="toggleNotifications()"></div>
                    </div>
                    <button class="btn btn-outline" onclick="testNotification()" id="testNotificationBtn" style="display: none;">
                        <span class="material-icons">notifications</span>
                        Test Notification
                    </button>
                </div>

                <!-- Bookings List -->
                <div id="bookingsList">
                    <!-- Bookings will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="emptyBookings" style="text-align: center; padding: 3rem 1rem; display: none;">
                    <span class="material-icons" style="font-size: 4rem; color: var(--text-light); margin-bottom: 1rem;">
                        event_available
                    </span>
                    <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">No bookings yet</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Book your first escape room experience!
                    </p>
                    <button class="btn btn-primary" onclick="showTab('home')">
                        <span class="material-icons">add</span>
                        Make a Booking
                    </button>
                </div>
            </div>

            <!-- Offline Screen -->
            <div class="offline-screen" id="offlineBookings">
                <!-- Will be populated by offline manager -->
            </div>
        </div>

        <!-- News Tab -->
        <div id="newsTab" class="tab-content">
            <h2 style="font-size: 1.75rem; font-weight: 600; margin-bottom: 1.5rem;">Latest News</h2>

            <div class="news-grid" style="display: grid; gap: 1.5rem;">
                <!-- News Item 1 -->
                <div class="card">
                    <div class="card-content">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 200px; border-radius: var(--radius-md); margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                            🎮
                        </div>
                        <h3 class="card-title">New QuestGames Released!</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">schedule</span>
                            December 15, 2024
                        </p>
                        <p style="color: var(--text-secondary); line-height: 1.6;">
                            We've just launched three new digital escape room experiences with enhanced graphics and more challenging puzzles. Try our latest adventures today!
                        </p>
                    </div>
                </div>

                <!-- News Item 2 -->
                <div class="card">
                    <div class="card-content">
                        <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); height: 200px; border-radius: var(--radius-md); margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                            🏆
                        </div>
                        <h3 class="card-title">Holiday Special Offers</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">schedule</span>
                            December 10, 2024
                        </p>
                        <p style="color: var(--text-secondary); line-height: 1.6;">
                            Book any QuestHouse experience in December and get 20% off your next booking. Perfect for holiday team building events!
                        </p>
                    </div>
                </div>

                <!-- News Item 3 -->
                <div class="card">
                    <div class="card-content">
                        <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); height: 200px; border-radius: var(--radius-md); margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                            📱
                        </div>
                        <h3 class="card-title">PWA Features Now Live!</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">schedule</span>
                            December 5, 2024
                        </p>
                        <p style="color: var(--text-secondary); line-height: 1.6;">
                            Install our app on your device for offline booking access, push notifications, and Apple Pay support!
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Photos Tab -->
        <div id="photosTab" class="tab-content">
            <h2 style="font-size: 1.75rem; font-weight: 600; margin-bottom: 1.5rem;">Photo Gallery</h2>

            <div class="photo-gallery" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                <!-- Photo 1 -->
                <div class="photo-item" style="aspect-ratio: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; cursor: pointer;" onclick="openPhotoModal('QuestBox Team Challenge', 'Amazing team building session at QuestBox!')">
                    🎯
                    <div style="position: absolute; bottom: 1rem; left: 1rem; font-size: 0.875rem; font-weight: 500;">
                        QuestBox Team Challenge
                    </div>
                </div>

                <!-- Photo 2 -->
                <div class="photo-item" style="aspect-ratio: 1; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; cursor: pointer;" onclick="openPhotoModal('QuestHouse Mystery Room', 'Players solving the final puzzle in our mystery room!')">
                    🔍
                    <div style="position: absolute; bottom: 1rem; left: 1rem; font-size: 0.875rem; font-weight: 500;">
                        QuestHouse Mystery Room
                    </div>
                </div>

                <!-- Photo 3 -->
                <div class="photo-item" style="aspect-ratio: 1; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; cursor: pointer;" onclick="openPhotoModal('QuestGames Victory', 'Team celebrating their escape room victory!')">
                    🏆
                    <div style="position: absolute; bottom: 1rem; left: 1rem; font-size: 0.875rem; font-weight: 500;">
                        QuestGames Victory
                    </div>
                </div>

                <!-- Photo 4 -->
                <div class="photo-item" style="aspect-ratio: 1; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; cursor: pointer;" onclick="openPhotoModal('Behind the Scenes', 'Our team setting up new puzzles and challenges!')">
                    🎭
                    <div style="position: absolute; bottom: 1rem; left: 1rem; font-size: 0.875rem; font-weight: 500;">
                        Behind the Scenes
                    </div>
                </div>

                <!-- Photo 5 -->
                <div class="photo-item" style="aspect-ratio: 1; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; cursor: pointer;" onclick="openPhotoModal('Group Adventure', 'Large group taking on our biggest challenge!')">
                    👥
                    <div style="position: absolute; bottom: 1rem; left: 1rem; font-size: 0.875rem; font-weight: 500;">
                        Group Adventure
                    </div>
                </div>

                <!-- Photo 6 -->
                <div class="photo-item" style="aspect-ratio: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; cursor: pointer;" onclick="openPhotoModal('EventX Facility', 'Welcome to our amazing EventX facility in Stockholm!')">
                    🏢
                    <div style="position: absolute; bottom: 1rem; left: 1rem; font-size: 0.875rem; font-weight: 500;">
                        EventX Facility
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profileTab" class="tab-content">
            <h2 style="font-size: 1.75rem; font-weight: 600; margin-bottom: 1.5rem;">My Profile</h2>

            <div class="profile-content" style="max-width: 600px;">
                <!-- User Info Card -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">Personal Information</h3>
                    </div>
                    <div class="card-content">
                        <div id="profileInfo">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <button class="btn btn-outline" onclick="editProfile()">
                            <span class="material-icons">edit</span>
                            Edit Profile
                        </button>
                    </div>
                </div>

                <!-- PWA Features Card -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">App Features</h3>
                    </div>
                    <div class="card-content">
                        <div class="feature-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h4 style="font-weight: 500; margin-bottom: 0.25rem;">Push Notifications</h4>
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">Get booking reminders</p>
                            </div>
                            <span id="pushStatus" style="color: var(--text-light); font-size: 0.875rem;">Checking...</span>
                        </div>

                        <div class="feature-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h4 style="font-weight: 500; margin-bottom: 0.25rem;">Apple Pay</h4>
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">Quick and secure payments</p>
                            </div>
                            <span id="applePayStatus" style="color: var(--text-light); font-size: 0.875rem;">Checking...</span>
                        </div>

                        <div class="feature-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h4 style="font-weight: 500; margin-bottom: 0.25rem;">Apple Wallet</h4>
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">Add tickets to wallet</p>
                            </div>
                            <span id="walletStatus" style="color: var(--text-light); font-size: 0.875rem;">Checking...</span>
                        </div>

                        <div class="feature-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="font-weight: 500; margin-bottom: 0.25rem;">Offline Support</h4>
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">View bookings offline</p>
                            </div>
                            <span id="offlineStatus" style="color: var(--success-color); font-size: 0.875rem;">Available</span>
                        </div>
                    </div>
                </div>

                <!-- Statistics Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Statistics</h3>
                    </div>
                    <div class="card-content">
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                            <div class="stat-item" style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);" id="totalBookings">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Total Bookings</div>
                            </div>
                            <div class="stat-item" style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary-color);" id="completedGames">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Games Completed</div>
                            </div>
                            <div class="stat-item" style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning-color);" id="favoriteService">-</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Favorite Service</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showTab('home')" data-tab="home">
            <span class="material-icons">home</span>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="showTab('bookings')" data-tab="bookings">
            <span class="material-icons">event</span>
            <span>Bookings</span>
            <div id="bookingsBadge" class="nav-badge" style="position: absolute; top: 4px; right: 12px; background: var(--danger-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.625rem; display: none; align-items: center; justify-content: center;"></div>
        </div>
        <div class="nav-item" onclick="showTab('news')" data-tab="news">
            <span class="material-icons">article</span>
            <span>News</span>
        </div>
        <div class="nav-item" onclick="showTab('photos')" data-tab="photos">
            <span class="material-icons">photo_library</span>
            <span>Photos</span>
        </div>
        <div class="nav-item" onclick="showTab('profile')" data-tab="profile">
            <span class="material-icons">account_circle</span>
            <span>Profile</span>
        </div>
    </nav>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; padding: 20px;">
        <div class="modal-content" style="background: white; border-radius: var(--radius-lg); max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: 1.25rem; font-weight: 600;" id="bookingModalTitle">Book Service</h3>
                <button onclick="closeBookingModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="bookingForm">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="bookingDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <select class="form-select" id="bookingTime" required>
                            <option value="">Select time</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="16:00">4:00 PM</option>
                            <option value="18:00">6:00 PM</option>
                            <option value="20:00">8:00 PM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Number of Participants</label>
                        <select class="form-select" id="bookingParticipants" required>
                            <option value="">Select participants</option>
                            <option value="1">1 person</option>
                            <option value="2">2 people</option>
                            <option value="3">3 people</option>
                            <option value="4">4 people</option>
                            <option value="5">5 people</option>
                            <option value="6">6 people</option>
                            <option value="7">7 people</option>
                            <option value="8">8 people</option>
                            <option value="9">9 people</option>
                            <option value="10">10 people</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Special Requirements (Optional)</label>
                        <textarea class="form-input" id="bookingNotes" rows="3" placeholder="Any special requests or requirements..."></textarea>
                    </div>

                    <!-- Payment Options -->
                    <div class="payment-section" style="margin: 1.5rem 0; padding: 1rem; background: var(--light-surface); border-radius: var(--radius-md);">
                        <h4 style="font-weight: 600; margin-bottom: 1rem;">Payment Method</h4>
                        <div class="payment-options" style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <!-- Apple Pay Button Container -->
                            <div id="applePayContainer"></div>

                            <!-- Standard Payment Button -->
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <span class="material-icons">payment</span>
                                Book Now - <span id="bookingPrice">0</span> SEK
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; padding: 20px;">
        <div class="modal-content" style="background: white; border-radius: var(--radius-lg); max-width: 600px; width: 100%;">
            <div class="modal-header" style="padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color);">
                <h3 style="font-size: 1.125rem; font-weight: 600;" id="photoModalTitle">Photo</h3>
                <button onclick="closePhotoModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 1.5rem; text-align: center;">
                <div id="photoModalImage" style="width: 100%; height: 300px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; font-size: 4rem; margin-bottom: 1rem;">
                    📸
                </div>
                <p id="photoModalDescription" style="color: var(--text-secondary); line-height: 1.6;">Photo description</p>
            </div>
        </div>
    </div>

    <!-- JavaScript Modules -->
    <script src="/js/push-notifications.js"></script>
    <script src="/js/apple-wallet.js"></script>
    <script src="/js/apple-pay.js"></script>
    <script src="/js/offline-manager.js"></script>

    <!-- Main Application JavaScript -->
    <script>
        // Global variables
        let currentUser = null;
        let currentService = null;
        let deferredPrompt = null;

        // Service prices
        const servicePrices = {
            'QuestBox': 500,
            'QuestGames': 300,
            'QuestHouse': 800
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            console.log('🚀 Initializing EventX Advanced PWA...');

            // Check if user is logged in
            const userData = localStorage.getItem('eventx-user');
            if (userData) {
                currentUser = JSON.parse(userData);
                showUserInterface();
            }

            // Initialize PWA features
            await initializePWA();

            // Set minimum date for booking
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('bookingDate').min = today;

            // Update PWA feature status
            updatePWAFeatureStatus();

            // Load user bookings
            loadUserBookings();

            // Update statistics
            updateUserStatistics();

            console.log('✅ App initialized successfully');
        }

        async function initializePWA() {
            // Register service worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('SW registered:', registration);

                    // Handle updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('New SW installed, update available');
                                showUpdateAvailable();
                            }
                        });
                    });
                } catch (error) {
                    console.error('SW registration failed:', error);
                }
            }

            // Handle PWA install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installButton').classList.add('show');
            });

            // Handle install button click
            document.getElementById('installButton').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const result = await deferredPrompt.userChoice;
                    if (result.outcome === 'accepted') {
                        console.log('PWA installed');
                    }
                    deferredPrompt = null;
                    document.getElementById('installButton').classList.remove('show');
                }
            });
        }

        function updatePWAFeatureStatus() {
            // Push notifications status
            if (window.pushManager) {
                const status = window.pushManager.getSubscriptionStatus();
                document.getElementById('pushStatus').textContent = status.isEnabled ? 'Enabled' : 'Available';
                document.getElementById('pushStatus').style.color = status.isEnabled ? 'var(--success-color)' : 'var(--text-light)';
            }

            // Apple Pay status
            if (window.applePayManager) {
                const status = window.applePayManager.getPaymentCapabilities();
                document.getElementById('applePayStatus').textContent = status.canMakePayment ? 'Available' : 'Not Available';
                document.getElementById('applePayStatus').style.color = status.canMakePayment ? 'var(--success-color)' : 'var(--text-light)';
            }

            // Apple Wallet status
            if (window.appleWalletManager) {
                const canAdd = window.appleWalletManager.canAddPassesToWallet();
                document.getElementById('walletStatus').textContent = canAdd ? 'Available' : 'Not Available';
                document.getElementById('walletStatus').style.color = canAdd ? 'var(--success-color)' : 'var(--text-light)';
            }
        }

        // Authentication functions
        function showAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginTab = document.getElementById('loginTabBtn');
            const registerTab = document.getElementById('registerTabBtn');

            if (tab === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
            }
        }

        // Handle form submissions
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            // Simple validation (in production, validate against server)
            const users = JSON.parse(localStorage.getItem('eventx-users') || '[]');
            const user = users.find(u => u.email === email && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('eventx-user', JSON.stringify(user));
                showUserInterface();

                // Cache user data for offline access
                if (window.offlineManager) {
                    window.offlineManager.cacheUserData(user);
                }

                showMessage('Welcome back! 👋', 'success');
            } else {
                showMessage('Invalid email or password', 'error');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const userData = {
                id: 'user_' + Date.now(),
                name: document.getElementById('registerName').value,
                email: document.getElementById('registerEmail').value,
                phone: document.getElementById('registerPhone').value,
                password: document.getElementById('registerPassword').value,
                joinDate: new Date().toISOString()
            };

            // Save user
            const users = JSON.parse(localStorage.getItem('eventx-users') || '[]');
            users.push(userData);
            localStorage.setItem('eventx-users', JSON.stringify(users));

            // Login user
            currentUser = userData;
            localStorage.setItem('eventx-user', JSON.stringify(userData));
            showUserInterface();

            // Cache user data for offline access
            if (window.offlineManager) {
                window.offlineManager.cacheUserData(userData);
            }

            showMessage('Account created successfully! 🎉', 'success');
        });

        function showUserInterface() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('servicesSection').style.display = 'block';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userEmail').textContent = currentUser.email;

            // Update profile info
            updateProfileInfo();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('eventx-user');

            document.getElementById('authSection').style.display = 'block';
            document.getElementById('servicesSection').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';

            // Clear forms
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();

            // Show home tab
            showTab('home');

            showMessage('Logged out successfully', 'info');
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Load tab-specific content
            if (tabName === 'bookings' && currentUser) {
                loadUserBookings();
            } else if (tabName === 'profile' && currentUser) {
                updateProfileInfo();
                updateUserStatistics();
            }
        }

        // Booking functions
        function showBookingForm(service) {
            if (!currentUser) {
                showMessage('Please login first', 'warning');
                return;
            }

            currentService = service;
            document.getElementById('bookingModalTitle').textContent = `Book ${service}`;
            document.getElementById('bookingPrice').textContent = servicePrices[service];

            // Show Apple Pay button if available
            if (window.applePayManager && window.applePayManager.canMakePayment) {
                const bookingDetails = {
                    service: service,
                    amount: servicePrices[service],
                    bookingId: 'temp_' + Date.now()
                };
                window.applePayManager.showApplePayButton(bookingDetails, 'applePayContainer');
            }

            document.getElementById('bookingModal').style.display = 'flex';
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').style.display = 'none';
            document.getElementById('bookingForm').reset();
            document.getElementById('applePayContainer').innerHTML = '';
        }

        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            processBooking();
        });

        function processBooking(paymentMethod = 'Standard') {
            const booking = {
                id: 'booking_' + Date.now(),
                userId: currentUser.id,
                service: currentService,
                date: document.getElementById('bookingDate').value,
                time: document.getElementById('bookingTime').value,
                participants: parseInt(document.getElementById('bookingParticipants').value),
                notes: document.getElementById('bookingNotes').value,
                price: servicePrices[currentService],
                paymentMethod: paymentMethod,
                status: 'confirmed',
                createdAt: new Date().toISOString(),
                customerName: currentUser.name,
                email: currentUser.email,
                phone: currentUser.phone
            };

            // Save booking
            const bookings = JSON.parse(localStorage.getItem('eventx-bookings') || '[]');
            bookings.push(booking);
            localStorage.setItem('eventx-bookings', JSON.stringify(bookings));

            // Cache booking for offline access
            if (window.offlineManager) {
                window.offlineManager.cacheBookingData(booking);
            }

            // Schedule push notifications
            if (window.pushManager && window.pushManager.isEnabled) {
                window.pushManager.scheduleBookingReminder(booking);
            }

            // Send email notification (EmailJS integration would go here)
            console.log('Booking created:', booking);

            closeBookingModal();
            showMessage(`${currentService} booked successfully! 🎉`, 'success');

            // Update bookings list
            loadUserBookings();
            updateUserStatistics();

            // Show bookings tab
            showTab('bookings');
        }

        function loadUserBookings() {
            if (!currentUser) return;

            const bookings = JSON.parse(localStorage.getItem('eventx-bookings') || '[]')
                .filter(b => b.userId === currentUser.id)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const bookingsList = document.getElementById('bookingsList');
            const emptyBookings = document.getElementById('emptyBookings');

            if (bookings.length === 0) {
                bookingsList.innerHTML = '';
                emptyBookings.style.display = 'block';
                return;
            }

            emptyBookings.style.display = 'none';
            bookingsList.innerHTML = bookings.map(booking => {
                const bookingDate = new Date(booking.date + ' ' + booking.time);
                const isUpcoming = bookingDate > new Date();

                return `
                    <div class="booking-card">
                        <div class="booking-header">
                            <h3>${booking.service}</h3>
                            <span class="booking-status" style="background: ${isUpcoming ? 'var(--success-color)' : 'var(--text-light)'}">
                                ${isUpcoming ? 'Upcoming' : 'Completed'}
                            </span>
                        </div>

                        ${isUpcoming ? `
                            <div class="countdown-timer" style="margin-bottom: 1rem;">
                                <div class="countdown-title">Time until your adventure</div>
                                <div class="countdown-display" id="countdown-${booking.id}">
                                    <div class="countdown-unit">
                                        <div class="countdown-value" id="days-${booking.id}">--</div>
                                        <div class="countdown-label">Days</div>
                                    </div>
                                    <div class="countdown-unit">
                                        <div class="countdown-value" id="hours-${booking.id}">--</div>
                                        <div class="countdown-label">Hours</div>
                                    </div>
                                    <div class="countdown-unit">
                                        <div class="countdown-value" id="minutes-${booking.id}">--</div>
                                        <div class="countdown-label">Minutes</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="booking-details">
                            <div class="detail-item">
                                <span class="material-icons">event</span>
                                <span>${booking.date} at ${booking.time}</span>
                            </div>
                            <div class="detail-item">
                                <span class="material-icons">group</span>
                                <span>${booking.participants} participants</span>
                            </div>
                            <div class="detail-item">
                                <span class="material-icons">payment</span>
                                <span>${booking.price} SEK (${booking.paymentMethod})</span>
                            </div>
                            <div class="detail-item">
                                <span class="material-icons">confirmation_number</span>
                                <span>ID: ${booking.id}</span>
                            </div>
                        </div>

                        <div class="booking-actions">
                            <button class="btn btn-outline" onclick="shareBooking('${booking.id}')">
                                <span class="material-icons">share</span>
                                Share
                            </button>
                            ${window.appleWalletManager && window.appleWalletManager.isSupported ? `
                                <button class="btn btn-outline" onclick="addToWallet('${booking.id}')">
                                    <span class="material-icons">account_balance_wallet</span>
                                    Add to Wallet
                                </button>
                            ` : ''}
                            <button class="btn btn-primary" onclick="viewTicket('${booking.id}')">
                                <span class="material-icons">local_activity</span>
                                View Ticket
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Start countdown timers
            bookings.filter(b => new Date(b.date + ' ' + b.time) > new Date())
                .forEach(booking => startCountdown(booking));

            // Update navigation badge
            const upcomingCount = bookings.filter(b => new Date(b.date + ' ' + b.time) > new Date()).length;
            const badge = document.getElementById('bookingsBadge');
            if (upcomingCount > 0) {
                badge.textContent = upcomingCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function startCountdown(booking) {
            const targetTime = new Date(booking.date + ' ' + booking.time).getTime();

            const timer = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetTime - now;

                if (distance < 0) {
                    clearInterval(timer);
                    loadUserBookings(); // Refresh to show as completed
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

                const daysEl = document.getElementById(`days-${booking.id}`);
                const hoursEl = document.getElementById(`hours-${booking.id}`);
                const minutesEl = document.getElementById(`minutes-${booking.id}`);

                if (daysEl) daysEl.textContent = days.toString().padStart(2, '0');
                if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
                if (minutesEl) minutesEl.textContent = minutes.toString().padStart(2, '0');
            }, 1000);
        }

        // Notification functions
        async function toggleNotifications() {
            const toggle = document.getElementById('notificationToggle');
            const testBtn = document.getElementById('testNotificationBtn');

            if (window.pushManager) {
                try {
                    if (window.pushManager.isEnabled) {
                        await window.pushManager.unsubscribe();
                        toggle.classList.remove('active');
                        testBtn.style.display = 'none';
                        showMessage('Push notifications disabled', 'info');
                    } else {
                        await window.pushManager.subscribe();
                        toggle.classList.add('active');
                        testBtn.style.display = 'block';
                        showMessage('Push notifications enabled! 🔔', 'success');
                    }
                    updatePWAFeatureStatus();
                } catch (error) {
                    console.error('Notification toggle failed:', error);
                    showMessage('Failed to toggle notifications', 'error');
                }
            }
        }

        async function testNotification() {
            if (window.pushManager && window.pushManager.isEnabled) {
                try {
                    await window.pushManager.sendTestNotification();
                } catch (error) {
                    showMessage('Test notification failed', 'error');
                }
            }
        }

        // Photo gallery functions
        function openPhotoModal(title, description) {
            document.getElementById('photoModalTitle').textContent = title;
            document.getElementById('photoModalDescription').textContent = description;
            document.getElementById('photoModal').style.display = 'flex';
        }

        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
        }

        // Profile functions
        function updateProfileInfo() {
            if (!currentUser) return;

            document.getElementById('profileInfo').innerHTML = `
                <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="info-item" style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Name:</span>
                        <span style="font-weight: 500;">${currentUser.name}</span>
                    </div>
                    <div class="info-item" style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Email:</span>
                        <span style="font-weight: 500;">${currentUser.email}</span>
                    </div>
                    <div class="info-item" style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Phone:</span>
                        <span style="font-weight: 500;">${currentUser.phone}</span>
                    </div>
                    <div class="info-item" style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Member since:</span>
                        <span style="font-weight: 500;">${new Date(currentUser.joinDate).toLocaleDateString()}</span>
                    </div>
                </div>
            `;
        }

        function updateUserStatistics() {
            if (!currentUser) return;

            const bookings = JSON.parse(localStorage.getItem('eventx-bookings') || '[]')
                .filter(b => b.userId === currentUser.id);

            const totalBookings = bookings.length;
            const completedGames = bookings.filter(b => new Date(b.date + ' ' + b.time) < new Date()).length;

            // Find favorite service
            const serviceCounts = bookings.reduce((acc, booking) => {
                acc[booking.service] = (acc[booking.service] || 0) + 1;
                return acc;
            }, {});

            const favoriteService = Object.keys(serviceCounts).length > 0 
                ? Object.keys(serviceCounts).reduce((a, b) => serviceCounts[a] > serviceCounts[b] ? a : b)
                : '-';

            document.getElementById('totalBookings').textContent = totalBookings;
            document.getElementById('completedGames').textContent = completedGames;
            document.getElementById('favoriteService').textContent = favoriteService === '-' ? '-' : favoriteService.replace('Quest', '');
        }

        // Utility functions
        function shareBooking(bookingId) {
            const bookings = JSON.parse(localStorage.getItem('eventx-bookings') || '[]');
            const booking = bookings.find(b => b.id === bookingId);

            if (booking) {
                const shareData = {
                    title: `EventX Booking - ${booking.service}`,
                    text: `My booking for ${booking.service} on ${booking.date} at ${booking.time}`,
                    url: window.location.origin + `/?booking=${bookingId}`
                };

                if (navigator.share) {
                    navigator.share(shareData);
                } else {
                    navigator.clipboard.writeText(`${shareData.title}\n${shareData.text}\n${shareData.url}`)
                        .then(() => showMessage('Booking details copied to clipboard!', 'success'));
                }
            }
        }

        function addToWallet(bookingId) {
            const bookings = JSON.parse(localStorage.getItem('eventx-bookings') || '[]');
            const booking = bookings.find(b => b.id === bookingId);

            if (booking && window.appleWalletManager) {
                window.appleWalletManager.generateBookingPass(booking);
            }
        }

        function viewTicket(bookingId) {
            if (window.offlineManager) {
                window.offlineManager.viewOfflineTicket(bookingId);
            }
        }

        function editProfile() {
            showMessage('Profile editing coming soon!', 'info');
        }

        function showUpdateAvailable() {
            if (confirm('A new version is available. Update now?')) {
                window.location.reload();
            }
        }

        function showMessage(message, type) {
            const messageEl = document.createElement('div');
            messageEl.className = `offline-message offline-message--${type}`;
            messageEl.innerHTML = `
                <span class="material-icons">
                    ${type === 'success' ? 'check_circle' : 
                      type === 'warning' ? 'warning' : 
                      type === 'error' ? 'error' : 'info'}
                </span>
                <span>${message}</span>
            `;

            document.body.appendChild(messageEl);

            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        // Apple Pay success callback
        window.onApplePaySuccess = function(result, bookingDetails) {
            console.log('Apple Pay success:', result);
            processBooking('Apple Pay');
        };

        // Apple Pay error callback
        window.onApplePayError = function(error) {
            console.error('Apple Pay error:', error);
            showMessage('Apple Pay payment failed', 'error');
        };

        // Handle keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeBookingModal();
                closePhotoModal();
            }
        });

        // Handle back button
        window.addEventListener('popstate', function(e) {
            if (e.state && e.state.tab) {
                showTab(e.state.tab);
            }
        });

        console.log('🎉 EventX Advanced PWA loaded successfully!');
    </script>
</body>
</html>
